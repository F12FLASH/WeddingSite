import { useState, useRef } from "react";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { Upload, Camera, Check, Image as ImageIcon, FileImage } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { uploadImageToCloudinary } from "@/lib/imageUpload";

export default function GuestPhotoUpload() {
  const { toast } = useToast();
  const queryClient = useQueryClient();
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [uploading, setUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [formData, setFormData] = useState({
    url: "",
    caption: "",
    guestName: "",
  });
  const [showSuccess, setShowSuccess] = useState(false);

  const uploadMutation = useMutation({
    mutationFn: async (data: typeof formData) => {
      return await apiRequest("POST", "/api/guest-photos", data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["/api/guest-photos"] });
      toast({
        title: "‚úÖ Upload Th√†nh C√¥ng!",
        description: "·∫¢nh c·ªßa b·∫°n ƒëang ch·ªù ƒë∆∞·ª£c duy·ªát v√† s·∫Ω xu·∫•t hi·ªán trong gallery s·ªõm.",
      });
      setShowSuccess(true);
      setFormData({ url: "", caption: "", guestName: "" });
      setTimeout(() => setShowSuccess(false), 3000);
    },
    onError: () => {
      toast({
        title: "‚ùå L·ªói",
        description: "Kh√¥ng th·ªÉ upload ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.",
        variant: "destructive",
      });
    },
  });

  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      toast({
        title: "‚ùå L·ªói",
        description: "Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh",
        variant: "destructive",
      });
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      toast({
        title: "‚ùå L·ªói",
        description: "K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB",
        variant: "destructive",
      });
      return;
    }

    setUploading(true);
    setUploadProgress(0);

    try {
      const imageUrl = await uploadImageToCloudinary(file, (progress) => {
        setUploadProgress(progress);
      });

      setFormData({ ...formData, url: imageUrl });

      toast({
        title: "‚úÖ T·∫£i l√™n th√†nh c√¥ng!",
        description: "·∫¢nh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n, h√£y ƒëi·ªÅn th√¥ng tin v√† g·ª≠i",
      });
    } catch (error) {
      toast({
        title: "‚ùå L·ªói",
        description: "Kh√¥ng th·ªÉ t·∫£i l√™n ·∫£nh",
        variant: "destructive",
      });
    } finally {
      setUploading(false);
      if (event.target) {
        event.target.value = '';
      }
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.url.trim()) {
      toast({
        title: "‚ö†Ô∏è Thi·∫øu th√¥ng tin",
        description: "Vui l√≤ng t·∫£i ·∫£nh l√™n ho·∫∑c nh·∫≠p link ·∫£nh",
        variant: "destructive",
      });
      return;
    }
    uploadMutation.mutate(formData);
  };

  return (
    <section id="guest-photos" data-testid="section-guest-photo-upload" className="py-20 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950/20 dark:to-purple-950/20">
      <div className="container mx-auto px-4">
        <div className="text-center mb-12">
          <div className="inline-block mb-4">
            <Camera className="w-12 h-12 text-primary mx-auto" />
          </div>
          <h2 className="font-heading text-4xl md:text-5xl lg:text-6xl font-bold mb-4">
            üì∏ Chia S·∫ª Kho·∫£nh Kh·∫Øc
          </h2>
          <p className="text-lg text-muted-foreground max-w-2xl mx-auto">
            H√£y upload ·∫£nh c·ªßa b·∫°n ch·ª•p trong ti·ªác ƒë·ªÉ chia s·∫ª nh·ªØng kho·∫£nh kh·∫Øc ƒë√°ng nh·ªõ!
          </p>
        </div>

        <div className="max-w-2xl mx-auto">
          <Card className="shadow-xl">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Upload className="w-5 h-5" />
                Upload ·∫¢nh C·ªßa B·∫°n
              </CardTitle>
              <CardDescription>
                ·∫¢nh c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ki·ªÉm duy·ªát v√† xu·∫•t hi·ªán trong gallery k·ª∑ ni·ªám
              </CardDescription>
            </CardHeader>
            <CardContent>
              <AnimatePresence mode="wait">
                {showSuccess ? (
                  <motion.div
                    key="success"
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={{ opacity: 1, scale: 1 }}
                    exit={{ opacity: 0, scale: 0.8 }}
                    className="text-center py-12"
                  >
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      transition={{ type: "spring", stiffness: 200, damping: 10 }}
                    >
                      <Check className="w-20 h-20 text-green-500 mx-auto mb-4" />
                    </motion.div>
                    <h3 className="text-2xl font-bold text-green-600 mb-2">
                      Upload Th√†nh C√¥ng!
                    </h3>
                    <p className="text-muted-foreground">
                      C·∫£m ∆°n b·∫°n ƒë√£ chia s·∫ª kho·∫£nh kh·∫Øc ƒë·∫πp
                    </p>
                  </motion.div>
                ) : (
                  <motion.form
                    key="form"
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    onSubmit={handleSubmit}
                    className="space-y-6"
                  >
                    <div className="space-y-2">
                      <Label htmlFor="photo-upload">T·∫£i ·∫¢nh L√™n *</Label>
                      <div className="flex gap-2">
                        <Button
                          type="button"
                          variant="outline"
                          className="flex-1 gap-2"
                          onClick={() => fileInputRef.current?.click()}
                          disabled={uploading}
                          data-testid="button-upload-from-device"
                        >
                          {uploading ? (
                            <>
                              <div className="w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin" />
                              ƒêang t·∫£i {uploadProgress}%
                            </>
                          ) : (
                            <>
                              <FileImage className="w-4 h-4" />
                              Ch·ªçn ·∫¢nh T·ª´ Thi·∫øt B·ªã
                            </>
                          )}
                        </Button>
                      </div>
                      <input
                        type="file"
                        ref={fileInputRef}
                        onChange={handleFileSelect}
                        accept="image/*"
                        className="hidden"
                      />
                      <p className="text-xs text-muted-foreground">
                        Ho·∫∑c nh·∫≠p link ·∫£nh b√™n d∆∞·ªõi n·∫øu ·∫£nh ƒë√£ ƒë∆∞·ª£c upload l√™n d·ªãch v·ª• kh√°c
                      </p>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="url">Link ·∫¢nh (T√πy ch·ªçn)</Label>
                      <Input
                        data-testid="input-photo-url"
                        id="url"
                        type="url"
                        placeholder="https://example.com/your-photo.jpg"
                        value={formData.url}
                        onChange={(e) => setFormData({ ...formData, url: e.target.value })}
                      />
                    </div>

                    {formData.url && (
                      <motion.div
                        initial={{ opacity: 0, height: 0 }}
                        animate={{ opacity: 1, height: "auto" }}
                        className="rounded-lg overflow-hidden border"
                      >
                        <img
                          src={formData.url}
                          alt="Preview"
                          className="w-full max-h-64 object-contain bg-muted"
                          onError={(e) => {
                            (e.target as HTMLImageElement).style.display = "none";
                          }}
                        />
                      </motion.div>
                    )}

                    <div className="space-y-2">
                      <Label htmlFor="guestName">T√™n C·ªßa B·∫°n</Label>
                      <Input
                        data-testid="input-guest-name"
                        id="guestName"
                        placeholder="T√™n b·∫°n..."
                        value={formData.guestName}
                        onChange={(e) => setFormData({ ...formData, guestName: e.target.value })}
                      />
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="caption">Ch√∫ Th√≠ch</Label>
                      <Textarea
                        data-testid="textarea-caption"
                        id="caption"
                        placeholder="M√¥ t·∫£ v·ªÅ b·ª©c ·∫£nh..."
                        value={formData.caption}
                        onChange={(e) => setFormData({ ...formData, caption: e.target.value })}
                        rows={3}
                      />
                    </div>

                    <Button
                      data-testid="button-submit-photo"
                      type="submit"
                      className="w-full gap-2"
                      size="lg"
                      disabled={uploadMutation.isPending}
                    >
                      {uploadMutation.isPending ? (
                        <>
                          <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                          ƒêang Upload...
                        </>
                      ) : (
                        <>
                          <Upload className="w-5 h-5" />
                          Upload ·∫¢nh
                        </>
                      )}
                    </Button>
                  </motion.form>
                )}
              </AnimatePresence>
            </CardContent>
          </Card>

          <div className="mt-6 text-center text-sm text-muted-foreground">
            <p>üí° <strong>M·∫πo:</strong> B·∫°n c√≥ th·ªÉ upload nhi·ªÅu ·∫£nh b·∫±ng c√°ch g·ª≠i form nhi·ªÅu l·∫ßn</p>
          </div>
        </div>
      </div>
    </section>
  );
}
